---
layout: post
title: django + docker + Azure(SQL)ë°°í¬
categories: django
---

### ğŸ“Œ **ì˜¤ëŠ˜ ë°°ìš°ê³  ì •ë¦¬í•œ ëª©ì°¨**

<br>

ï¼‘. django + docker + Azure(SQL)ë°°í¬

<br>

<br>

## ğŸ” ***ë„ì»¤ë¥¼ í†µí•œ ë°°í¬***

<br>

### ğŸ“Œ ***Azureë°°í¬ë¥¼ ìœ„í•œ staticíŒŒì¼ ì„¤ì •***
ï¼‘. ë©”ì¸ í”„ë¡œì íŠ¸ íŒŒì¼ì— storages.pyë¥¼ ë§Œë“¤ì–´ ì¤€ë‹¤.

- `django-storage[azure]` installí•˜ê¸°
- requirements.txtì— ì ì–´ì£¼ê¸°
- INSTALLED_APPì—ëŠ” ì•ˆì ì–´ì¤˜ë„ ëœë‹¤.

```python
#storages.py

from storages.backends.azure_storage import AzureStorage

class StaticAzureStorage(AzureStorage):
    azure_container = "static"
```

<br>

ï¼’. settings/prod.pyì—ì„œ STATICFILES_STORAGE ì„¤ì •í•œë‹¤.

-DEBUG = Fasleì¼ ê²½ìš° ALLOWED_HOSTSë¥¼ ê¼­ ì„¤ì •í•´ì•¼ í•œë‹¤.

```python
# prod.py
import os

DEBUG = os.environ.get("DEBUG") in ["1", "t", "true", "T", "True"]
ALLOWED_HOSTS = os.environ.get("ALLOWED_HOSTS", "").split(",")

STATICFILES_STORAGE = "gstore.storages.StaticAzureStorage"
```
---

<br>

ï¼“. Azure Storages Accountsì—ì„œ staticí´ë” ë§Œë“¤ê¸°

ì´ ë¶€ë¶„ì—ì„œ í™˜ê²½ë³€ìˆ˜ë¥¼ ì…ë ¥í•´ì¤˜ì•¼ í•˜ëŠ”ë° ì²˜ìŒì—ëŠ” ëª¨ë“  keyë“¤ì„ .jsoníŒŒì¼ì— ê´€ë¦¬í•´ì„œ 

ì‚¬ìš©í–ˆëŠ”ë° ì¢‹ì§€ ì•Šì€ ë°©ë²•ì´ë¼ê³  í–ˆë‹¤. 

í´ë”ë¥¼ ë§Œë“¤ê³  `python manage.py collacticstatic --settings=project_name.settings.prod`

ìœ„ ëª…ë ¹ì–´ë¡œ Azure Storages Accountsì— í˜„ì¬ í”„ë¡œì íŠ¸ ë‚´ ëª¨ë“  static íŒŒì¼ ë³µì‚¬í•´ì„œ ë„£ê¸°.

---

<br>

<br>

### ğŸ“Œ ***Docker Image Build***
ï¼‘. Dockerfile ìƒì„±

- manage.pyì™€ ê°™ì€ ê²½ë¡œì— ìƒì„±í•´ì¤€ë‹¤.

```python
FROM ubuntu:18.04

RUN apt-get update && \
    apt-get install -y python3-pip && \
    apt-get clean

RUN apt-get install -y libpq-dev

WORKDIR /code
ADD . /code
RUN pip3 install -r requirements.txt

ENV PYTHONUNBUFFERED=1

EXPOSE 80
CMD ["gunicorn", "gstore.wsgi:application", "--bind", "0.0.0.0:80"]
```

ë’¤ì—ì„œ ë„ì»¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¶€ë¶„ì—ì„œ `psycopg2` ëª¨ë“ˆì„ ì°¾ì§€ ëª»í•˜ëŠ” ë¬¸ì œê°€ ìƒê²¼ë‹¤. 

êµ¬ê¸€ë§ ê²°ê³¼ `apt-get install -y libpq-dev`ë¥¼ ì‘ì„±í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì˜€ë‹¤. 

<br>

libpqì— ëŒ€í•´ì„œ [postgreSQL Docs](https://www.postgresql.org/docs/9.5/libpq.html)ì—ì„œ ê²€ìƒ‰í•´ ë´¤ë‹¤.

"libpqëŠ” PostgreSQLì— ëŒ€í•œ C ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡œê·¸ë˜ë¨¸ì˜ ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.

libpqëŠ” í´ë¼ì´ì–¸íŠ¸ í”„ë¡œê·¸ë¨ì´ PostgreSQL ë°±ì—”ë“œ ì„œë²„ì— ì¿¼ë¦¬ë¥¼ ì „ë‹¬í•˜ê³  

ì´ëŸ¬í•œ ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ìˆ˜ì‹ í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ í•¨ìˆ˜ ì„¸íŠ¸" ë¼ê³  í•œë‹¤.

<br>

ê²°êµ­ ì˜¤ë¥˜ì˜ ì›ì¸ì€ ë¹Œë“œ ê³¼ì • ì¤‘ì— postgresql library íŒ¨í‚¤ì§€ê°€ í•„ìš”í•œë°,

ì´ íŒ©í‚¤ì§€ê°€ ì—†ì–´ì„œ ë¹Œë“œì˜¤ë¥˜ê°€ ë°œìƒí•œ ê²ƒì´ë¼ê³  ìƒê°ëœë‹¤. ê·¸ë¦¬ê³  libpqë¥¼ 

ì„¤ì¹˜í•¨ìœ¼ë¡œì¨ `psycopg2`ëª¨ë“ˆ ë¹Œë“œì‹œ í•„ìš”í•œ libraryë¥¼ ë‹¤ìš´ ë°›ì€ ê²ƒì´ì—ˆë‹¤.

---

<br>

<br>

### ğŸ“Œ ***Azure PosetgreSQL + Docker migration***
ï¼‘. Azure Database for PostgreSQL servers

- ì—¬ê¸°ì— ë“¤ì–´ê°€ì„œ DB ìƒì„±

<br>

ï¼’. settings/prod.pyì—ì„œ DBì„¤ì •
```python
DATABASES = {
    "default": {
        "ENGINE": os.environ["DB_ENGINE"],
        "HOST": os.environ["DB_HOST"],
        "USER": os.environ["DB_USER"],
        "PASSWORD": os.environ["DB_PASSWORD"],
        "NAME": os.environ["DB_NAME"],
    },
}
```

<br>

ï¼’. Docker migration
```markdown
docker run --rm --publish 9998:80 
        -e DJANGO_SETTINGS_MODULE= 
        -e AZURE_ACCOUNT_NAME=
        -e AZURE_ACCOUNT_KEY=" " 
        -e ALLOWED_HOSTS=
        -e DB_ENGINE=
        -e DB_HOST=
        -e DB_USER=
        -e DB_PASSWORD=
        -e DB_NAME=
        -it name sh
```
- docker shellì— ì§„ì…í•œë‹¤. 

- `python3 manage.py showmigrations`ë¡œ í˜„ì¬ ìƒíƒœ í™•ì¸

- `python3 manage.py migarte` ì§„í–‰

- superuser ìƒì„±

---

<br>

<br>

### ğŸ“Œ ***Azure PaaS ì„œë¹„ìŠ¤ì— ë°°í¬***
ï¼‘. Docker Hubì— Push
```python
> docker login

> docker push username/imagename:1.0
```

<br>

ï¼’. Azure App Service
```python
# Azure ë‚´ë¶€ì—ì„œ VMì„ ì‚¬ìš©í•œë‹¤.
> Publish : Doker Container

> OS : Linux

> Image Source : Docker Hub
```

<br>

ï¼“. ì¶”ê°€ ì„¤ì •ì‚¬í•­
```python
> Propertiesì— ë“¤ì–´ê°„ë‹¤.

> Virtual IP addressì™€ Outbound IP addressë¥¼ ë³µì‚¬í•œë‹¤.

> Connection securityì— ë“¤ì–´ê°€ì„œ ë¶™í˜€ë„£ê¸°.

> Allow access to Azure services : YES
```