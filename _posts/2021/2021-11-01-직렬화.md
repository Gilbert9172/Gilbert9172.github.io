---
layout: post
title: JSON ì§ë ¬í™”
categories: django
tags: drf
---

### ğŸ’¡ ***Serialization(ì§ë ¬í™”)***

ëª¨ë“  í”„ë¡œê·¸ë˜ë° ì–¸ì–´ì˜ í†µì‹ ì—ì„œ ë°ì´í„°ëŠ” í•„íˆ <span style="color:#4682B4">**ë¬¸ìì—´**</span> ë˜ëŠ” <span style="color:#4682B4">**ë°”ì´íŠ¸**</span>ë¡œ 

í‘œí˜„ ë˜ì–´ì•¼ í•œë‹¤. 

ì¦‰, ë°ì´í„°ë¥¼ ë¬¸ìì—´ ë˜ëŠ” ë°”ì´íŠ¸ë¡œ ë³€í™˜í•´ì£¼ëŠ” ì‘ì—…ì„ <span style="color:#DC143C">**ì§ë ¬í™”**</span>ë¼ê³  í•œë‹¤.

ì†¡ì‹ ìì˜ ê²½ìš°ì—ëŠ” ê°ì²´ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬, ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê³ (ì§ë ¬í™”)

ìˆ˜ì§„ìì˜ ì…ì¥ì—ì„œëŠ” ìˆ˜ì‹ í•œ ë¬¸ìì—´ì„ ë‹¤ì‹œ ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬(ë¹„ì§ë ¬í™”) ë°ì´í„°ë¥¼ 

í™œìš©í•´ì•¼ í•œë‹¤. ë˜í•œ ê° ì–¸ì–´ì—ì„œ ëª¨ë‘ ì§€ì›í•˜ëŠ” ì§ë ¬í™” í¬ë§·(JSON, XML ë“±)ë„

ìˆê³ , íŠ¹ì • ì–¸ì–´ì—ì„œë§Œ ì§€ì›í•˜ëŠ” ì§ë ¬í™” í¬ë©§(python-pickle)ì´ ìˆë‹¤.

---

<br>

### ğŸ’¡ ***JSON VS Pickle***

##### JSON

ï¼‘. ë‹¤ë¥¸ ì–¸ì–´/í”Œë«í¼ê³¼ í†µì‹ í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©.

ï¼’. í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ json ì œê³µ

ï¼“. Pickleì— ë¹„í•´ ì§ë ¬í™”ë¥¼ ì§€ì›í•˜ëŠ” ë°ì´í„°íƒ€ì…ì˜ ìˆ˜ê°€ ì ì§€ë§Œ, ì»¤ìŠ¤í…€ ê°€ëŠ¥

ï¼”. <span style="color:#4682B4">**ì—°ì†ì„±**</span> ë°ì´í„°ì— ì£¼ë¡œ í™œìš©

```python
import json

data = [{'message':'django'}]

# ì§ë ¬í™” - ë¬¸ìì—´ íƒ€ì…
json_string = json.dumps(data)
print(json_string) 
# ì¶œë ¥: [{'message':'django'}]

# ë¹„ì§ë ¬í™”
print(json.loads(json_string))
# ì¶œë ¥: [{'message':'django'}]
```

<br>

##### Pickle 

ï¼‘. íŒŒì´ì¬ ì „ìš© í¬ë§·ìœ¼ë¡œì„œ íŒŒì´ì¬ ì‹œìŠ¤í…œë¼ë¦¬ë§Œ í†µì‹ í•  ë•Œ ì‚¬ìš© ê°€ëŠ¥

ï¼’. í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ pickle ì œê³µ â†’ json ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ìœ ì‚¬í•œ ì‚¬ìš© ë°©ë²•

ï¼“. íŒŒì´ì¬ ë²„ì „ íŠ¹ì„±ì„ íƒ€ëŠ” ê²½ìš°ê°€ ìˆìŒ.

ï¼”. <span style="color:#4682B4">**ì„ì‹œì„±**</span> ë°ì´í„°ì— ì£¼ë¡œ í™œìš©

```python
import pickle

data = [{'message':'django'}]

# ì§ë ¬í™” - ë°”ì´íŠ¸ íƒ€ì…
pickle_string = pickle.dumps(data)
print(pickle_string)
"""
b'\x80\x04\x95\x1a\x00\x00\x00\x00\x00\x00\x00]\x94}
\x94\x8c\x07message\x94\x8c\x06django\x94sa.'
"""

# ë¹„ì§ë ¬í™”
print(pickle.loads(pickle_string))
# ì¶œë ¥: [{'message': 'django'}]
```

í•˜ì§€ë§Œ JSON/Pickle ëª¨ë‘ íŒŒì´ì¬ ê¸°ë³¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ë‹¤. 

ë”°ë¼ì„œ <span style="color:#DC143C">**ì¥ê³  íƒ€ì…(Model/Queryset ë“±)ì— ëŒ€í•´ì„œëŠ” ì§ë ¥í™” Ruleì´ ì—†ë‹¤.**</span>

ë§Œì•½ì— Querysetì„ ì§ë ¬í™”ë¥¼ ì‹œë„í•  ê²½ìš°ì—ëŠ” ì•„ë˜ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤.

<span style="color:#DC143C">**TypeError: Object of type QuerySet is not JSON serializable**</span>

<img src="/assets/img/django/jsonerror.png">

---

<br>

### ğŸ’¡ ***DjagnoJSONEncoder***

ìœ„ì™€ ê°™ì´ ì—ëŸ¬ê°€ ìƒê¸´ê²½ìš° DjagnoJSONEncoderë¥¼ ì‹œë„í•´ì„œ ëª‡ ê°€ì§€

Ruleì„ ì¶”ê°€ë¡œ ë¶€ì—¬í•  ìˆ˜ ìˆë‹¤.

```python
import json
from django.core.serializers.json import DjangoJSONEncoder
from django.contrib.auth import get_user_model

qs = get_user_model().objects.all()
json_string = json.dumps(qs, cls=DjangoJSONEncoder)
```

ìœ„ì™€ ê°™ì´ `cls` ì¸ìë¥¼ ì‚¬ìš©í•˜ì—¬ DjagnoJSONEncoderë¥¼ í™œìš©í•  ìˆ˜ ìˆë‹¤. 

í•˜ì§€ë§Œ ì—¬ê¸°ì„œë„ ì—­ì‹œë‚˜ <span style="color:Red">**TypeError: Object of type QuerySet is not JSON serializable**</span>

ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤. ê·¸ëŸ¬ë©´ ì–´ë–»ê²Œ ìœ„ ì—ëŸ¬ë¥¼ í•´ê²°í•  ìˆ˜ ìˆì„ê¹Œ??

<br>

List-Comprehensionì„ ì‚¬ìš©í•˜ì—¬ <span style="color:#4682B4">**"ì§ì ‘ ë³€í™˜"**</span> í•´ì£¼ë©´ ëœë‹¤.

```python
data = [
    {'id': post.id, 'title': post.title, 'content': post.content} for post in Post.objects.all()
]

json.dumps(data, ensure_ascii=False)
```
ì—¬ê¸°ì„œ <span style="color:#4682B4">**ensure_ascii**</span> íŒŒë¼ë¯¸í„°ì˜ defaultê°’ì€ Trueì´ë‹¤.

ì•„ë˜ì™€ ê°™ì´ Trueì¼ ê²½ìš°ì—ëŠ” ìœ ë‹ˆì½”ë“œë¥¼ ë°˜í™˜í•´ì£¼ê³ , 

Falseì¼ ê²½ìš° ë¬¸ìì—´ì„ ê·¸ë˜ë„ ë°˜í™˜í•´ì¤€ë‹¤.

```python
import json

print(json.dumps('ì„œìš¸'))
# "\uc11c\uc6b8"

print(json.dumps('ì„œìš¸', ensure_ascii=False))
# "ì„œìš¸"
```

<br>

### ğŸ’¡ ***ì§ì ‘ Rule ì§€ì •***

í•˜ì§€ë§Œ ë§¤ë²ˆ ì§ì ‘ ë³€í™˜í•˜ê²Œ ë˜ë©´ ì‹œê°„ë„ ì˜¤ë˜ê±¸ë¦¬ê³  ë¹„íš¨ìœ¨ì ì´ë‹¤.

ë”°ë¼ì„œ <span style="color:#4682B4">**"ì§ì ‘ ë³€í™˜ Rule"**</span>ì„ ì§€ì •í•˜ëŠ” ë°©ë²•ì´ ìµœì„ ì´ë‹¤.

```python
from django.core.serializers.json import DjangoJSONEncoder
from django.db.models.query import Queryset

#ì»¤ìŠ¤í„° JSON Encoderë¥¼ ì •ì˜
class MyJSONEncoder(DjangoJSONEncoder):
    def default(self,obj):
        if isinstance(obj, Queryset):
            return tuple(obj)

        elif isinstance(obj, Post):
            return {'id': obj.id, 'title': obj.title, 'content': obj.content}

        elif hasattr(obj, 'as_dict'):
            return obj.as_dict()

        # ìœ„ì˜ ë¡œì§ ëª¨ë‘ ì‹¤íŒ¨ì‹œ 
        return super().default(obj)

data = Post.objects.all()

# ì§ë ¬í™” í•  ë•Œ, ì§ë ¬í™”ë¥¼ ìˆ˜í–‰í•´ì¤„ JSON Encoderë¥¼ ì§€ì •í•´ì¤ë‹ˆë‹¤.
json.dumps(data, cls = MyJSONEncoder, ensure_ascii=False)
```
---

<br>

### ğŸ’¡ ***DRF - JSONRender***

rest_framwork/utils/encoders.pyì˜ <span style="color:#4682B4">**JSONEncoder**</span>ë¥¼ í†µí•œ ì§ë ¬í™”.

Model íƒ€ì…ì€ ì—¬ê¸°ì„œ ì§€ì›í•˜ì§€ ì•Šê³ , ModelSerializerì—ì„œ ì§€ì›í•´ì¤€ë‹¤.

<br>

- ì¥ê³ ì˜ DjangoJSONEncoderë¥¼ ìƒì†ë°›ì§€ ì•Šê³ , json.JSONEncoder ìƒì†ì„ í†µí•´ êµ¬í˜„

- datetime.datetime/date/time/timedelta

- decimal.Decimal, uuid.UUID, six.binary_type

- `__getitem__` ì†ì„±ì„ ì§€ì›í•  ê²½ìš° dict(obj)

- `__iter__` ì†ì„±ì„ ì§€ì›í•  ê²½ìš° tupleë³€í™˜

- QuerySet íƒ€ì…ì¼ ê²½ìš°, tuple ë³€í™˜

- `.tolist` ì†ì„±ì„ ì§€ì›í•  ê²½ìš°, obj.tolist() ë°˜í™˜

---

<br>

### ğŸ’¡ ***DRF - JSONRenderer***

JSONRendererëŠ” <span style="color:#4682B4">**json.dumps**</span>ë¥¼ ë˜í•‘í•œ í´ë˜ìŠ¤ì´ë‹¤.

JSONRendererëŠ” ë³´ë‹¤ í¸ë¦¬í•œ ì§ë ¬í™”ë¥¼ ì§€ì›í•´ì£¼ê³ , UTF-8 ì¸ì½”ë”©ë„ ì¶”ê°€ì ìœ¼ë¡œ ìˆ˜í–‰í•´ì¤€ë‹¤.

í•˜ì§€ë§Œ ì—¬ê¸°ì—ì„œë„ Modelì— ëŒ€í•œ ë³€í™˜ Ruleì€ ì—†ë‹¤.

```python
from rest_framework.renderers import JSONRenderer

data = Post.objects.all()

serializer = PostSerializer(data, many=True)

JSONRenderer().render(serializer.data)
```
---

<br>

### ğŸ’¡ ***Model Serializerë¥¼ í†µí•œ JSONì§ë ¬í™”***

Serializer/ModelSerializer í´ë˜ìŠ¤ëŠ” íƒ€ ì–¸ì–´ì˜ ì„œë¹„ìŠ¤ ì˜ì—­ì„ ë‹´ë‹¹í•œë‹¤ê³  

ë³¼ ìˆ˜ ìˆë‹¤. ì‹¤ì œ ë°ì´í„° ìƒì„±, ìˆ˜ì •, ì¡°íšŒ ë¡œì§ì„ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

ë˜í•œ Form/ModelFormê³¼ ìœ ì‚¬í•œ ì¸¡ë©´ì´ ìˆì§€ë§Œ ê¸°ëŠ¥ì´ ì¡°ê¸ˆ ë” ë§ë‹¤.

<img src="/assets/img/django/serializer.png">

```python
# serializers.py
from rest_framework.serializers import ModelSerializer
from .models import Post

class PostSerializer(ModelSerializer):
    class Meta:
        model = Post
        fields = '__all__'

# forms.py
from django.forms import ModelForm
from .models import Post

class PostForm(ModelFrom):
    class Meta:
        model = Post
        fields = '__all__'
```
---

<br>

#### ModelFormê³¼ ìœ ì‚¬í•œ ModelSerializer

ë°ì´í„° í•œê°œë§Œ ë„˜ê¸¸ ê²½ìš°ëŠ” ì•„ë˜ì™€ ê°™ì´.
<img src="/assets/img/django/modelserializer.png">

```python
from rest_framework.serializers import ModelSerializer
from .models import Post

class PostSerializer(ModelSerializer):
    class Meta:
        model = Post
        fields = '__all__'

# Post íƒ€ì…
post = Post.objects.first()

serializer = PostSerializer(post)

# ReturnDict íƒ€ì…
serializer.data
```

<br>

ë°ì´í„° ë‘ê°œ ì´ìƒ ë„˜ê¸¸ ê²½ìš°ì—ëŠ” `many=True`ë¥¼ ê¼­ ì§€ì •í•´ì¤˜ì•¼í•œë‹¤.

ì´ ê²½ìš°ì— ë°˜í™˜ ê°’ì€ <span style="color:#4682B4">**listì™€ OrdererDictì˜ ì¡°í•©**</span>ì´ë‹¤.

<img src="/assets/img/django/modelserializer1.png">

---

<br>

#### ReturnDict íƒ€ì…

ì‹¤ì œ serializer.dataì˜ ë°ì´í„° íƒ€ì…ì´ë‹¤.

OrderedDictë¥¼ ìƒì† ë°›ì•˜ìœ¼ë©°, serializerë¥¼ í‚¤ì›Œë“œ ì¸ìë¡œ ë°›ëŠ”ë‹¤.

```python
class ReturnDict(OrderedDict): 
    def __init__(self, *args, **kwargs):
        self.serializer = kwargs.pop('serializer')
        super().__init__(*arg, **kwargs)

```
---

<br>

#### ModelSerializerì˜ QuerySet ë³€í™˜ ì§€ì›

Modelì˜ ê°ì²´ì— ëŒ€í•´ì„œëŠ” many=False(default)ë¥¼ ì§€ì •í•´ì¤˜ì•¼ í•œë‹¤. 

ë°˜ë©´ì—, QuerySet ê°ì²´ì— ëŒ€í•´ì„œëŠ” many=Trueë¥¼ ì§€ì •í•´ì¤˜ì•¼ í•œë‹¤.

ë§Œì•½ manyì˜ ì§€ì •ì´ ì˜³ì§€ ì•Šì„ ê²½ìš° TypeError, AttributeErrorê°€ ë°œìƒí•œë‹¤.

```python
# íŒŒì´ì¬ ê¸°ë³¸ JSON ë³€í™˜ ì‚¬ìš© í™œìš© 
# ë¬¸ìì—´ í˜•ì‹
import json
json_str_string = json.dumps(serializer.data, ensure_ascii=False) 

# DRFì—ì„œ ì§€ì›í•˜ëŠ” JSON ë³€í™˜ í™œìš© â†’ ë³€í™˜ Ruleì´ ì¶”ê°€ëœ Encoder
# ë°”ì´íŠ¸ í˜•ì‹
from rest_framework.renderers import JSONRenderer
json_utf8_string = JSONRenderer().render(serializer.data)
```
---