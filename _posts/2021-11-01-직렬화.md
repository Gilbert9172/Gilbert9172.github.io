---
layout: post
title: JSON 직렬화
categories: django
tags: drf
---

### 💡 ***Serialization(직렬화)***

모든 프로그래밍 언어의 통신에서 데이터는 필히 <span style="color:#4682B4">**문자열**</span> 또는 <span style="color:#4682B4">**바이트**</span>로 

표현 되어야 한다. 

즉, 데이터를 문자열 또는 바이트로 변환해주는 작업을 <span style="color:#DC143C">**직렬화**</span>라고 한다.

송신자의 경우에는 객체를 문자열로 변환하여, 데이터를 전송하고(직렬화)

수진자의 입장에서는 수신한 문자열을 다시 객체로 변환하여(비직렬화) 데이터를 

활용해야 한다. 또한 각 언어에서 모두 지원하는 직렬화 포맷(JSON, XML 등)도

있고, 특정 언어에서만 지원하는 직렬화 포멧(python-pickle)이 있다.

---

<br>

### 💡 ***JSON VS Pickle***

##### JSON

１. 다른 언어/플랫포과 통신할 때 주로 사용.

２. 표준 라이브러리 json 제공

３. Pickle에 비해 직렬화를 지원하는 데이터타입의 수가 적지만, 커스텀 가능

４. <span style="color:#4682B4">**연속성**</span> 데이터에 주로 활용

```python
import json

data = [{'message':'django'}]

# 직렬화 - 문자열 타입
json_string = json.dumps(data)
print(json_string) 
# 출력 : [{'message':'django'}]

# 비직렬화
print(json.loads(json_string))
[{'message':'django'}]
```

<br>

##### Pickle 

１. 파이썬 전용 포맷으로서 파이썬 시스템끼리만 통신할 때 사용 가능

２. 표준 라이브러리 pickle 제공 → json 라이브러리가 유사한 사용 방법

３. 파이썬 버전 특성을 타는 경우가 있음.

４. <span style="color:#4682B4">**임시성**</span> 데이터에 주로 활용

```python
import pickle

data = [{'message':'django'}]

# 직렬화 - 바이트 타입
pickle_string = pickle.dumps(data)
print(pickle_string)
"""
b'\x80\x04\x95\x1a\x00\x00\x00\x00\x00\x00\x00]\x94}
\x94\x8c\x07message\x94\x8c\x06django\x94sa.'
"""

# 비직렬화
print(pickle.loads(pickle_string))
# 출력: [{'message': 'django'}]
```

<br>

하지만 JSON/Pickle 모두 파이썬 기본 라이브러리이다. 

따라서 <span style="color:#DC143C">**장고 타입(Model/Queryset 등)에 대해서는 직력화 규칙이 없다.**</span>

만약에 Queryset을 직렬화를 시도할 경우에는 아래와 같은 오류가 발생한다.

<span style="color:Red">**TypeError: Object of type QuerySet is not JSON serializable**</span>

<img src="/assets/img/django/jsonerror.png">

<br>

하지만 <span style="color:#4682B4">***DjagnoJSONEncoder***</span>를 통해 Rule을 추가할 수 있다.

```python
import json
from django.core.serializers.json import DjangoJSONEncoder
from django.contrib.auth import get_user_model

qs = get_user_model().objects.all()
json_string = json.dumps(qs, cls=DjangoJSONEncoder)
```

위와 같이 `cls` 인자를 사용하여 활용할 수 있다. 

하지만 여기서도 역시나 <span style="color:Red">**TypeError: Object of type QuerySet is not JSON serializable**</span>

에러가 발생한다. 그러면 어떻게 위 에러를 해결할 수 있을까??

<br>

List-Comprehension을 사용하여 <span style="color:#4682B4">**"직접 변환"**</span> 해주면 된다.

```python
data = [
    {'id': post.id, 'title': post.title, 'content': post.content} for post in Post.objects.all()
]

json.dumps(data, ensure_ascii=False)
```
여기서 <span style="color:#4682B4">**ensure_ascii**</span> 파라미터의 default값은 True이다.

아래와 같이 True일 경우에는 유니코드를 반환해주고, 

False일 경우 문자열을 그래도 반환해준다.

```python
import json

print(json.dumps('서울'))
# "\uc11c\uc6b8"

print(json.dumps('서울', ensure_ascii=False))
# "서울"
```

<br>

하지만 매번 직접 변환하게 되면 시간도 오래걸리고 비효율적이다.

따라서 <span style="color:#4682B4">**"직접 변환 Rule"</span>을 지정하는 방법이 최선이다.