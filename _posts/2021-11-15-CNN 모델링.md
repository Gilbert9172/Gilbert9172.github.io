---
layout: post
title: CNNì„ í™œìš©í•œ ì´ë¯¸ì§€ ë¶„ë¥˜
categories: deeplearning
tags: cnn
---

### ğŸ’¡ ***CNN ëª¨ë¸ë§ ì‹¤ìŠµ***

#### MNIST ë°ì´í„° ë¡œë“œ
```python
from tensorflow import keras
from sklearn.model_selection import train_test_split


(train_input, train_target), (test_input,test_target) = \
    keras.datasets.fashion_mnist.load_data()

# Conv2DëŠ” ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ ê¹Šì´ ì°¨ì›ì„ ì¶”ê°€í•´ì¤˜ì•¼ í•œë‹¤.
train_scaled = train_input.reshape(-1,28,28,1)/255

train_scaled, val_scaled, train_target, val_target = train_test_split(
    train_scaled, train
```
---

<br>

#### ëª¨ë¸ë§
```python
# Sequential() í†µí•œ ëª¨ë¸ ê°ì²´ ìƒì„±
model = keras.Sequential()

#ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ ì²« ë²ˆì§¸ í•©ì„±ê³±-í’€ë§ ì¸µ ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“#

# Conv2D
model.add(keras.layers.Conv2D(
    32,
    kernel_size=3,
    activation='relu',
    padding='same',
    input_shape=(28,28,1)
))

# Pooling
model.add(keras.layers.MaxPooling2D(2, strides=2, padding='valid'))

#ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ ë‘ ë²ˆì§¸ í•©ì„±ê³±-í’€ë§ ì¸µ ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“#

model.add(keras.layers.Conv2D(
    64,
    kernel_size=3,
    activation='relu',
    padding='same'    
))

model.add(keras.layers.MaxPooling2D(2, strides=2, padding='valid'))

#ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ 3ì°¨ì› íŠ¹ì„± ë§µì„ 1ì°¨ì›ìœ¼ë¡œ ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“ã€“#

# Flatten
model.add(keras.layers.Flatten())

# ì€ë‹‰ì¸µ
model.add(keras.layers.Dense(100,activation='relu'))

# Dropout ì€ë‹‰ì¸µì˜ ê³¼ëŒ€ì í•©ì„ ì˜ˆë°©.
model.add(keras.layers.Dropout(0.4))

# ì¶œë ¥ì¸µ
model.add(keras.layers.Dense(10, activation='softmax'))

# ëª¨ë¸ ìƒì„¸
model.summary()
```

ì•„ë˜ëŠ” summary ì¶œë ¥ê°’ì´ë‹¤.

<img src="/assets/img/django/cnn6.png">

1. ì²« ë²ˆì§¸ í•©ì„±ê³±ì¸µ
- í•„í„°ê°€ : 32ê°œ
- í•„í„° í¬ê¸° : (3,3,1)
- ì ˆí¸ : 32ê°œ

    > Param = (3x3x1x32) + 32 = 320

<br>

2. ë‘ ë²ˆì§¸ í•©ì„±ê³±ì¸µ
- í•„í„°ê°€ : 64ê°œ
- í•„í„° í¬ê¸° : (3,3,32)
- ì ˆí¸ : 64ê°œ

    > Param = (3x3x32x64) + 64 = 18496      

<br>

3. Flatten
    > Output Shape : 7x7x62 = (3136,)

<br>

4. ì€ë‹‰ì¸µ 

    > Param = 3136 x 10 + 100 = 313700

<br>

5. ì¶œë ¥ì¸µ

    > Parma = 100 x 10 + 10 = 1010

---

<br>

#### ì¸µì˜ êµ¬ì„± ì‹œê°í™”

**`show_shapes=True`** ë¡œ ì§€ì •í•´ì£¼ì§€ ì•Šìœ¼ë©´ input,outputì€ ì¶œë ¥ë˜ì§€ ì•ŠëŠ”ë‹¤.

**`to_file = "name.í™•ì¥ì"`** ë¥¼ ì§€ì •í•´ì£¼ë©´ ì¶œë ¥ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•  ìˆ˜ ìˆë‹¤.


```python
keras.utils.plot_model(model, show_shapes=True)
```

<img src="/assets/img/django/cnn7.png">

---

<br>

#### ëª¨ë¸ ì»´íŒŒì¼ & í›ˆë ¨
```python
model.compile(
    optimizer='adam',
    loss='sparse_categorical_crossentropy',
    metrics='accuracy'
)

# ì½œë°±
checkpoint_cb = keras.callbacks.ModelCheckpoint(
    'best-cnn-model.h5',
    save_best_only = True
)

# ì¡°ê¸° ì¢…ë£Œ
early_stopping_cb = keras.callbacks.EarlyStopping(
    patience=2,
    restore_best_weights=True
)

# ëª¨ë¸ í›ˆë ¨
history = model.fit(train_scaled, train_target, epochs=20,
                    validation_data=(val_scaled,val_target),
                    callbacks = [checkpoint_cb, early_stopping_cb])
```
<img src="/assets/img/django/cnn9.png">

---

<br>

#### ì†ì‹¤ ê³¡ì„  ì‹œê°í™”
```python
import matplotlib.pyplot as plt

plt.plot(history.history['loss'])
plt.plot(history.history['val_loss'])

plt.xlabel('epoch')
plt.ylabel('loss')

plt.legend(['train','val'])

plt.show()
```

8ë²ˆ ì—í¬í¬ì™€ ê²°ê³¼ê°€ ê°™ë‹¤ëŠ”ê±¸ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<img src="/assets/img/django/cnn8.png">

---

<br>

#### test_input ì´ë¯¸ì§€ ì˜ˆì¸¡í•´ë³´ê¸°
```python
# test set ì„±ëŠ¥ ì¸¡ì •
test_scaled = test_input.reshape(-1,28,28,1)/255
model.evaluate(test_scaled,test_target)

# test_scaled ì˜ˆì¸¡
test_pred = model.predict(test_scaled)

# ì¼ë¶€ë§Œ ì‹œê°í™”
fig,axs = plt.subplots(2,2,figsize=(9,9))

for i in range(2):
    axs[i,0].imshow(test_input[i].reshape(28,28), cmap='gray_r')
    axs[i,1].bar(range(1,11),test_pred[i])

plt.show()
```
<img src="/assets/img/django/cnn10.png">

ì¶”ê°€ì ìœ¼ë¡œ **`predict()`** ì— ìƒ˜í”Œ í•˜ë‚˜ë¥¼ ì „ë‹¬í•  ë•Œ <span style="color:#008B8B">**ìŠ¬ë¼ì´ì‹±**</span>ì„ ì‚¬ìš©í•´ì•¼í•œë‹¤.

kerasì—ì„œ fit(), predict(), evaluate() ë©”ì„œë“œëŠ” ëª¨ë‘ ì…ë ¥ì˜ ì²« ë²ˆì§¸ ì°¨ì›ì´

ë°°ì¹˜ ì°¨ì›ì¼ ê²ƒìœ¼ë¡œ ê¸°ëŒ€í•œë‹¤. ë”°ë¼ì„œ ìƒ˜í”Œ í•˜ë‚˜ë¥¼ ì „ë‹¬í•  ë•Œ (28,28,1)ì´ ì•„ë‹ˆë¼

(1,28,28,1) í¬ê¸°ë¥¼ ì „ë‹¬í•´ì•¼ í•œë‹¤. ë°°ì—´ ìŠ¬ë¼ì´ì‹±ì€ ì¸ë±ì‹±ê³¼ ë‹¤ë¥´ê²Œ ì„ íƒëœ ì›ì†Œê°€

í•˜ë‚˜ì´ë”ë¼ë„ ì „ì²´ ì°¨ì›ì´ ìœ ì§€ë˜ì–´ (1,28,28,1) í¬ê¸°ë¥¼ ë§Œë“ ë‹¤.

ì•„ë˜ ì‚¬ì§„ì²˜ëŸ¼ ìŠ¬ë¼ì´ì‹± í–ˆì„ ë•Œì™€ ì•„ë‹ ë•Œ shapeì˜ ì°¨ì´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

<img src="/assets/img/django/cnn11.png">

---