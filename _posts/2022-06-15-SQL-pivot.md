---
layout: post
title: SQLì—ì„œ pivot í…Œì´ë¸” ìƒì„±í•˜ê¸°
categories: sql
---

## <span style="color:gray">CASEë¥¼ í™œìš©í•œ pivot í…Œì´ë¸”</span>

#### ì¿¼ë¦¬ ë¬¸
```sql
select
    ts.sensorkit_name as sensorkit_name
    ,max(case when a.sensor_id = 'carbon_dioxide' then a.sensor_data end) as carbon_dioxide
    ,max(case when a.sensor_id = 'carbon_monoxide' then a.sensor_data end) as carbon_monoxide
    ,max(case when a.sensor_id = 'fine_dust' then a.sensor_data end) as fine_dust
    ,max(case when a.sensor_id = 'humidity' then a.sensor_data end) as humidity
    ,max(case when a.sensor_id = 'temperature' then a.sensor_data end) as temperature
    ,max(case when a.sensor_id = 'ultrafine_dust' then a.sensor_data end) as ultrafine_dust
    ,max(case when a.sensor_id = 'visitor_cnt' then a.sensor_data end) as visotor_cnt
    ,max(case when a.sensor_id = 'voc' then a.sensor_data end) as voc
   from
     (select tsd.sensorkit_id, tsd.sensor_id, avg(tsd.sensor_data)::numeric(10, 2) as sensor_data
      from tb_sensor_data tsd
      group by sensorkit_id, sensor_id) as a
   inner join tb_sensorkit ts
   on a.sensorkit_id = ts.sensorkit_id
   group by sensorkit_name;
```

**`max`** ë¥¼ ì“°ì§€ ì•Šìœ¼ë©´ í•˜ë‚˜ì˜ indexì— ëŒ€í•´ ì—„ì²­ ë§ì€ rowê°€ ìƒê¸´ë‹¤. 

|  |col1|col2|col3|col4|col5|
|--|----|----|----|----|----|
|a|1|null|null|null|null|
|a|null|2|null|null|null|
|a|null|null|3|null|null|
|a|null|null|null|4|null|
|a|null|null|null|null|5|

í•˜ì§€ë§Œ **`max`** ë¥¼ ì‚¬ìš©í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ë°”ë€ë‹¤.

|  |col1|col2|col3|col4|col5|
|--|----|----|----|----|----|
|a|1|2|3|4|5|

<br>

## <span style="color:gray">FILTER í™œìš©í•œ pivot í…Œì´ë¸”</span>

postgreSqlì—ì„œëŠ” FILTERë¼ëŠ” ë©”ì„œë“œë¥¼ ì œê³µí•´ì¤€ë‹¤. FILTERì˜ ê²½ìš° ì§‘ê³„ëœ í–‰ì„ 

ê´„í˜¸ ì•ˆì˜ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” í–‰ìœ¼ë¡œ ì œí•œí•œë‹¤. ì´ê²Œ ë¬´ìŠ¨ ë§ì´ëƒë©´...

```sql
COALESCE(MAX(a.sensor_data) FILTER (WHERE a.sensor_id = 'carbon_dioxide'),0) carbon_dioxide
```

â†’ COALESCE : Nullì¸ ê²½ìš° 0ìœ¼ë¡œ ì²˜ë¦¬.

> í•˜ì§€ë§Œ FILTERì˜ ê²½ìš° PostgreSQLê³¼ SQLiteì—ì„œë§Œ ì§€ì›í•´ì£¼ê¸° ë•Œë¬¸ì— ì‚¬ìš©í•˜ì§€ ì•Šì•˜ë‹¤.

<br>

## <span style="color:gray">crosstab í™œìš©í•œ pivot í…Œì´ë¸”</span>

PostgreSQLì—ëŠ” tablefunc extensionì—ì„œ ì§€ì›í•˜ëŠ” crosstabì„ í™œìš©í•  ìˆ˜ ìˆë‹¤.

ì£¼ì˜í•  ì ì€ crosstabì€ aggregateê°€ ì´ë¯¸ ë˜ì–´ ìˆëŠ” í…Œì´ë¸”ì—ì„œ pivotë§Œ ê°€ëŠ¥í•˜ë‹¤.

ë¨¼ì €, tableì„ aggregateí•œ í›„ crosstabì— ì ìš©í•´ì•¼ í•œë‹¤.

> ì„±ê³µí•´ë³¸ì ì´ ì—†ë‹¤...

---

<br>

## <span style="color:gray">ì •ë¦¬</span>

***ì°¸ê³  ë¸”ë¡œê·¸1*** ì—ì„œë„ ë³¼ ìˆ˜ ìˆë“¯, CASEë¬¸ì„ ì‚¬ìš©í•´ì„œ pivot í…Œì´ë¸”ì„ ë§Œë“œëŠ” ê²ƒì´ ê°€ì¥ ì¼ë°˜ì ì¸

ë°©ë²•ì¸ê±° ê°™ë‹¤. ì™œëƒë©´ FILTERë‚˜ crossTabì˜ ê²½ìš°ì—ëŠ” íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤ì— ì¢…ì†ì ì´ê¸°

ë•Œë¬¸ì´ë‹¤.

**ğŸ“š [ì°¸ê³  ë¸”ë¡œê·¸1](https://modern-sql.com/use-case/pivot)**

**ğŸ“š [ì°¸ê³  ë¸”ë¡œê·¸2](https://yahwang.github.io/posts/76)**

**ğŸ“š [ë¸Œë¼ìš°ì €ì—ì„œ ì¿¼ë¼í•˜ëŠ” ì‚¬ì´íŠ¸](https://www.db-fiddle.com/)**

---